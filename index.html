<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è¥å…»å°ç®¡å®¶ - é¥®é£Ÿè®°å½• & ä½“é‡ç®¡ç†</title>
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
}
body {
  background: #fdf6f9;
  color: #333;
  padding: 1rem;
  max-width: 768px;
  margin: 0 auto;
  position: relative;
}

/* å¡é€šèƒŒæ™¯å°å…ƒç´  */
body::before {
  content: "ğŸ";
  position: fixed;
  top: 5%;
  left: 5%;
  font-size: 2rem;
  opacity: 0.2;
  z-index: -1;
}
body::after {
  content: "ğŸ¥¦";
  position: fixed;
  bottom: 10%;
  right: 8%;
  font-size: 2.2rem;
  opacity: 0.2;
  z-index: -1;
}

/* ä¸»ç•Œé¢ */
.header {
  text-align: center;
  margin: 1rem 0 1.5rem;
}
.header h1 {
  color: #ff7b9c;
  font-size: 1.7rem;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
}
.header h1::before {
  content: "ğŸ½ï¸";
  font-size: 1.8rem;
}
.user-bar {
  text-align: right;
  margin-bottom: 1rem;
  font-size: 0.9rem;
  color: #666;
}
.user-bar span {
  color: #ff7b9c;
  font-weight: 500;
}

/* é€‰é¡¹å¡ */
.tabbar {
  display: flex;
  background: white;
  border-radius: 16px;
  overflow: hidden;
  margin-bottom: 1rem;
  box-shadow: 0 2px 10px rgba(0,0,0,0.05);
}
.tab {
  flex: 1;
  text-align: center;
  padding: 0.9rem 0.5rem;
  font-size: 0.95rem;
  cursor: pointer;
  color: #666;
}
.tab.active {
  background: #ff7b9c;
  color: white;
}

/* å¡ç‰‡ */
.card {
  background: white;
  border-radius: 16px;
  padding: 1.2rem;
  margin-bottom: 1rem;
  box-shadow: 0 2px 10px rgba(0,0,0,0.05);
  position: relative;
}
.card::before {
  content: "";
  position: absolute;
  top: 10px;
  right: 12px;
  font-size: 1.5rem;
  opacity: 0.15;
}
.card-profile::before { content: "ğŸ‘¤"; }
.card-target::before { content: "ğŸ“Š"; }
.card-meal::before { content: "ğŸ½ï¸"; }
.card-search::before { content: "ğŸ”"; }
.card-food::before { content: "ğŸ¥—"; }
.card-total::before { content: "ğŸ“ˆ"; }
.card-weight::before { content: "âš–ï¸"; }
.card-report::before { content: "ğŸ“„"; }
.card-recipe::before { content: "ğŸ±"; }

.card h2 {
  font-size: 1.15rem;
  margin-bottom: 1rem;
  color: #444;
  display: flex;
  align-items: center;
  gap: 0.4rem;
}
.card h2::before {
  content: "â€¢";
  color: #ff7b9c;
  font-size: 1.3rem;
}

.form-row {
  display: flex;
  gap: 0.6rem;
  margin-bottom: 0.9rem;
  flex-wrap: wrap;
}
.form-row input,
.form-row select {
  flex: 1;
  min-width: 100px;
  padding: 0.8rem;
  border: 1px solid #f0cde0;
  border-radius: 12px;
  font-size: 0.95rem;
  outline: none;
}
.form-row input:focus,
.form-row select:focus {
  border-color: #ff7b9c;
}

.btn-mini {
  padding: 0.6rem 0.9rem;
  font-size: 0.9rem;
  border-radius: 10px;
  border: none;
  background: #ff7b9c;
  color: white;
  cursor: pointer;
}
.btn-mini.danger {
  background: #ff6b6b;
}

.info-row {
  font-size: 0.95rem;
  margin-bottom: 0.5rem;
  color: #555;
}
.nutri-row {
  display: flex;
  flex-wrap: wrap;
  gap: 1rem;
  font-size: 0.95rem;
  color: #666;
  margin: 0.8rem 0;
}

/* æœç´¢è”æƒ³ */
.suggest {
  border: 1px solid #f0cde0;
  border-radius: 12px;
  margin-top: 0.7rem;
  max-height: 200px;
  overflow-y: auto;
}
.suggest-item {
  padding: 0.8rem;
  border-bottom: 1px solid #f8e4ef;
  cursor: pointer;
  font-size: 0.95rem;
}
.suggest-item:hover {
  background: #fff0f5;
}
.suggest-item:last-child {
  border-bottom: none;
}

/* æ”¶è— */
.fav-list {
  margin-top: 0.7rem;
}
.fav-item {
  display: flex;
  justify-content: space-between;
  padding: 0.7rem 0;
  border-bottom: 1px dashed #f0cde0;
  font-size: 0.95rem;
}
.fav-item .del {
  color: #ff6b6b;
  cursor: pointer;
  font-weight: bold;
}

/* é¤é£Ÿåˆ—è¡¨ */
.meal-list .item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.7rem 0;
  border-bottom: 1px dashed #f0cde0;
  font-size: 0.95rem;
}

/* è¿›åº¦æ¡ */
.progress-item {
  margin-bottom: 1rem;
}
.progress-item .text {
  font-size: 0.95rem;
  margin-bottom: 0.4rem;
  color: #555;
}
.progress-bar {
  width: 100%;
  height: 10px;
  background: #f8e4ef;
  border-radius: 5px;
  overflow: hidden;
}
.progress-fill {
  height: 100%;
  background: #ff7b9c;
  border-radius: 5px;
}

/* æ¯é¤å¯¹æ¯” */
.meal-compare {
  margin-bottom: 0.9rem;
}
.meal-compare .text {
  font-size: 0.95rem;
  margin-bottom: 0.4rem;
  color: #555;
}

/* å›¾è¡¨ */
canvas {
  width: 100%;
  height: 190px;
  border-radius: 12px;
  margin-top: 0.7rem;
  background: #fdf6f9;
}

/* å†å²è®°å½• */
.history-item {
  display: flex;
  justify-content: space-between;
  padding: 0.7rem 0;
  border-bottom: 1px dashed #f0cde0;
  font-size: 0.95rem;
}

/* æŠ¥å‘Š */
.report {
  white-space: pre-line;
  font-size: 0.95rem;
  line-height: 1.6;
  background: #fdf6f9;
  padding: 1.2rem;
  border-radius: 12px;
  margin-top: 0.8rem;
  color: #444;
}

/* é£Ÿè°± */
.recipe-item {
  padding: 1rem;
  border-bottom: 1px dashed #f0cde0;
}
.recipe-item:last-child {
  border-bottom: none;
}
.recipe-item h3 {
  font-size: 1.05rem;
  margin-bottom: 0.5rem;
  color: #ff7b9c;
}
.recipe-item p {
  font-size: 0.95rem;
  color: #555;
  line-height: 1.5;
}

/* å†…å®¹åŒº */
.tab-content {
  display: none;
}
.tab-content.show {
  display: block;
}

/* åˆ†äº«æŒ‰é’® */
.share-btn {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background: #ff7b9c;
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.2rem;
  box-shadow: 0 4px 12px rgba(255,123,156,0.3);
  cursor: pointer;
  z-index: 100;
}
</style>
</head>
<body>

<!-- åˆ†äº«æŒ‰é’® -->
<div class="share-btn" onclick="shareApp()" title="åˆ†äº«ç»™å¥½å‹">ğŸ”—</div>

<!-- ä¸»ç•Œé¢ -->
<div class="header">
  <h1>è¥å…»å°ç®¡å®¶</h1>
</div>

<div class="tabbar">
  <div class="tab active" onclick="switchTab('diet')">é¥®é£Ÿè®°å½•</div>
  <div class="tab" onclick="switchTab('weight')">ä½“é‡å›¾è¡¨</div>
  <div class="tab" onclick="switchTab('report')">è¥å…»æŠ¥å‘Š</div>
  <div class="tab" onclick="switchTab('recipe')">é£Ÿè°±æ¨è</div>
</div>

<!-- ========== é¥®é£Ÿè®°å½• ========== -->
<div id="diet" class="tab-content show">
  <div class="card card-profile">
    <h2>ğŸ‘¤ ä¸ªäººä¿¡æ¯</h2>
    <div class="form-row">
      <select id="gender">
        <option value="male">ç”·</option>
        <option value="female">å¥³</option>
      </select>
      <input type="number" id="age" placeholder="å¹´é¾„" value="25">
      <input type="number" id="height" placeholder="èº«é«˜(cm)" value="165">
      <input type="number" id="weight" placeholder="ä½“é‡(kg)" value="55">
    </div>
    <div class="form-row">
      <select id="activity">
        <option value="1.2">ä¹…å</option>
        <option value="1.375">è½»åº¦æ´»åŠ¨</option>
        <option value="1.55">ä¸­åº¦æ´»åŠ¨</option>
        <option value="1.725">é«˜åº¦æ´»åŠ¨</option>
        <option value="1.9">æé«˜æ´»åŠ¨</option>
      </select>
      <select id="mode">
        <option value="maintain">ç»´æŒ</option>
        <option value="lose">å‡è„‚</option>
        <option value="gain">å¢è‚Œ</option>
        <option value="pregnant">å­•å¦‡</option>
      </select>
    </div>
    <button class="btn" onclick="calcTarget()" style="width:100%;padding:0.9rem;border-radius:12px;background:#ff7b9c;color:white;border:none;font-weight:500;cursor:pointer;">è®¡ç®—æ¨èæ‘„å…¥</button>
  </div>

  <div class="card card-target" id="targetCard" style="display:none">
    <h2>ğŸ“Š æ¯æ—¥æ¨èç›®æ ‡</h2>
    <div class="info-row">åŸºç¡€ä»£è°¢ BMRï¼š<span id="bmr">0</span> kcal</div>
    <div class="info-row">æ¯æ—¥æ¶ˆè€— TDEEï¼š<span id="tdee">0</span> kcal</div>
    <div class="info-row">æ¨èçƒ­é‡ï¼š<span id="targetCal">0</span> kcal</div>
    <div class="info-row">è›‹ç™½è´¨ï¼š<span id="targetPro">0</span> g</div>
    <div class="info-row">è„‚è‚ªï¼š<span id="targetFat">0</span> g</div>
    <div class="info-row">ç¢³æ°´ï¼š<span id="targetCar">0</span> g</div>
  </div>

  <div class="card card-meal" id="mealSplitCard" style="display:none">
    <h2>ğŸ½ï¸ æ¯é¤åˆ†é… & æ‘„å…¥å¯¹æ¯”</h2>
    <div class="meal-compare">
      <div class="text">æ—©é¤ï¼š<span id="breakfastTotal">0</span> / <span id="breakfastTarget">0</span> kcal</div>
      <div class="progress-bar"><div class="progress-fill" id="breakfastPer" style="width:0%"></div></div>
    </div>
    <div class="meal-compare">
      <div class="text">åˆé¤ï¼š<span id="lunchTotal">0</span> / <span id="lunchTarget">0</span> kcal</div>
      <div class="progress-bar"><div class="progress-fill" id="lunchPer" style="width:0%"></div></div>
    </div>
    <div class="meal-compare">
      <div class="text">æ™šé¤ï¼š<span id="dinnerTotal">0</span> / <span id="dinnerTarget">0</span> kcal</div>
      <div class="progress-bar"><div class="progress-fill" id="dinnerPer" style="width:0%"></div></div>
    </div>
    <div class="meal-compare">
      <div class="text">åŠ é¤ï¼š<span id="snackTotal">0</span> / <span id="snackTarget">0</span> kcal</div>
      <div class="progress-bar"><div class="progress-fill" id="snackPer" style="width:0%"></div></div>
    </div>
  </div>

  <div class="card card-search">
    <h2>ğŸ” é£Ÿç‰©æœç´¢</h2>
    <div class="form-row">
      <input type="text" id="searchFood" placeholder="è¾“å…¥é£Ÿç‰©å" oninput="onSearchInput()">
      <button class="btn-mini" onclick="fillFood()">å¡«å……</button>
      <button class="btn-mini" onclick="toggleFav()">æ”¶è—</button>
    </div>
    <div id="suggest" class="suggest" style="display:none"></div>
    <div id="favList" class="fav-list" style="display:none"></div>
  </div>

  <div class="card card-food">
    <h2>ğŸ¥— é£Ÿç‰©å½•å…¥</h2>
    <div class="form-row">
      <input type="number" id="foodGram" placeholder="é‡é‡(g)" value="100">
    </div>
    <div class="nutri-row">
      <span>çƒ­é‡ï¼š<span id="foodCal">0</span> kcal</span>
      <span>è›‹ç™½ï¼š<span id="foodPro">0</span> g</span>
      <span>è„‚è‚ªï¼š<span id="foodFat">0</span> g</span>
      <span>ç¢³æ°´ï¼š<span id="foodCar">0</span> g</span>
    </div>
    <div class="form-row">
      <button class="btn-mini" onclick="addMeal('breakfast')">åŠ æ—©é¤</button>
      <button class="btn-mini" onclick="addMeal('lunch')">åŠ åˆé¤</button>
      <button class="btn-mini" onclick="addMeal('dinner')">åŠ æ™šé¤</button>
      <button class="btn-mini" onclick="addMeal('snack')">åŠ åŠ é¤</button>
      <button class="btn-mini" onclick="addFav()">æ”¶è—å½“å‰</button>
    </div>
  </div>

  <div class="card">
    <h2>ğŸ¥ æ—©é¤</h2>
    <div id="breakfastList" class="meal-list"></div>
  </div>
  <div class="card">
    <h2>ğŸ± åˆé¤</h2>
    <div id="lunchList" class="meal-list"></div>
  </div>
  <div class="card">
    <h2>ğŸ² æ™šé¤</h2>
    <div id="dinnerList" class="meal-list"></div>
  </div>
  <div class="card">
    <h2>ğŸ åŠ é¤</h2>
    <div id="snackList" class="meal-list"></div>
  </div>

  <div class="card card-total" id="totalCard" style="display:none">
    <h2>ğŸ“ˆ ä»Šæ—¥æ‘„å…¥ / ç›®æ ‡</h2>
    <div class="progress-item">
      <div class="text">çƒ­é‡ï¼š<span id="totalCal">0</span> / <span id="totalCalTarget">0</span> kcal</div>
      <div class="progress-bar"><div class="progress-fill" id="totalCalPer" style="width:0%"></div></div>
    </div>
    <div class="progress-item">
      <div class="text">è›‹ç™½è´¨ï¼š<span id="totalPro">0</span> / <span id="totalProTarget">0</span> g</div>
      <div class="progress-bar"><div class="progress-fill" id="totalProPer" style="width:0%"></div></div>
    </div>
    <div class="progress-item">
      <div class="text">è„‚è‚ªï¼š<span id="totalFat">0</span> / <span id="totalFatTarget">0</span> g</div>
      <div class="progress-bar"><div class="progress-fill" id="totalFatPer" style="width:0%"></div></div>
    </div>
    <div class="progress-item">
      <div class="text">ç¢³æ°´ï¼š<span id="totalCar">0</span> / <span id="totalCarTarget">0</span> g</div>
      <div class="progress-bar"><div class="progress-fill" id="totalCarPer" style="width:0%"></div></div>
    </div>
  </div>

  <button class="btn danger" onclick="clearAll()" style="margin-bottom:2rem;width:100%;padding:0.9rem;border-radius:12px;background:#ff6b6b;color:white;border:none;font-weight:500;cursor:pointer;">æ¸…ç©ºä»Šæ—¥è®°å½•</button>
</div>

<!-- ========== ä½“é‡å›¾è¡¨ ========== -->
<div id="weight" class="tab-content">
  <div class="card card-weight">
    <h2>âœï¸ ä»Šæ—¥ä½“é‡</h2>
    <div class="form-row">
      <input type="number" step="0.1" id="todayWeight" placeholder="ä½“é‡(kg)">
      <button class="btn" onclick="saveWeight()" style="padding:0.8rem 1.2rem;border-radius:12px;background:#ff7b9c;color:white;border:none;font-weight:500;cursor:pointer;">ä¿å­˜</button>
    </div>
  </div>
  <div class="card">
    <h2>ğŸ“… ä½“é‡è¶‹åŠ¿ï¼ˆè¿‘30å¤©ï¼‰</h2>
    <canvas id="weightChart"></canvas>
  </div>
  <div class="card">
    <h2>ğŸ“‹ å†å²è®°å½•</h2>
    <div id="weightHistory"></div>
  </div>
</div>

<!-- ========== è¥å…»æŠ¥å‘Š ========== -->
<div id="report" class="tab-content">
  <div class="card card-report">
    <h2>ğŸ“„ ä»Šæ—¥è¥å…»åˆ†ææŠ¥å‘Š</h2>
    <div id="reportContent" class="report">è¯·å…ˆè®¡ç®—æ¨èç›®æ ‡å¹¶è®°å½•é¥®é£Ÿ</div>
    <button class="btn" onclick="genReport()" style="width:100%;padding:0.9rem;border-radius:12px;background:#ff7b9c;color:white;border:none;font-weight:500;cursor:pointer;">ç”ŸæˆæŠ¥å‘Š</button>
  </div>
</div>

<!-- ========== é£Ÿè°±æ¨è ========== -->
<div id="recipe" class="tab-content">
  <div class="card card-recipe">
    <h2>ğŸ± ä¸ªæ€§åŒ–é£Ÿè°±æ¨è</h2>
    <div id="recipeList"></div>
    <button class="btn" onclick="genRecipe()" style="width:100%;padding:0.9rem;border-radius:12px;background:#ff7b9c;color:white;border:none;font-weight:500;cursor:pointer;">åˆ·æ–°æ¨è</button>
  </div>
</div>

<script>
// ==============================
// å†…ç½®é£Ÿç‰©åº“
// ==============================
const FOOD_DB = {
  "ç™½ç±³é¥­": { cal: 116, pro: 2.6, fat: 0.3, car: 25.9 },
  "ç³™ç±³é¥­": { cal: 110, pro: 2.6, fat: 0.9, car: 23.8 },
  "é¦’å¤´": { cal: 223, pro: 7.0, fat: 1.1, car: 45.7 },
  "é¢æ¡": { cal: 110, pro: 2.7, fat: 0.2, car: 23.5 },
  "é¸¡èƒ¸è‚‰": { cal: 118, pro: 23.1, fat: 2.2, car: 0 },
  "ç˜¦ç‰›è‚‰": { cal: 125, pro: 20.2, fat: 4.2, car: 1.3 },
  "é¸¡è›‹": { cal: 143, pro: 12.6, fat: 9.9, car: 1.5 },
  "ä¸‰æ–‡é±¼": { cal: 142, pro: 20.8, fat: 6.3, car: 0 },
  "ç‰›å¥¶": { cal: 54, pro: 3.2, fat: 3.2, car: 3.4 },
  "æ— ç³–é…¸å¥¶": { cal: 72, pro: 4.0, fat: 1.5, car: 7.0 },
  "è±†è…": { cal: 76, pro: 8.1, fat: 4.8, car: 2.8 },
  "è‹¹æœ": { cal: 52, pro: 0.3, fat: 0.2, car: 13.8 },
  "é¦™è•‰": { cal: 89, pro: 1.1, fat: 0.3, car: 22.8 },
  "è¥¿å…°èŠ±": { cal: 34, pro: 2.8, fat: 0.4, car: 6.6 },
  "è èœ": { cal: 23, pro: 2.9, fat: 0.4, car: 3.6 },
  "æä»": { cal: 579, pro: 21.1, fat: 49.9, car: 14.3 },
  "æ ¸æ¡ƒ": { cal: 654, pro: 15.2, fat: 65.2, car: 13.9 },
  "çº¢è–¯": { cal: 86, pro: 1.6, fat: 0.1, car: 20.1 },
  "åœŸè±†": { cal: 77, pro: 2.0, fat: 0.2, car: 17.2 },
  "ç•ªèŒ„": { cal: 18, pro: 0.9, fat: 0.2, car: 3.9 },
  "é»„ç“œ": { cal: 15, pro: 0.6, fat: 0.2, car: 2.9 }
};
const FOOD_NAMES = Object.keys(FOOD_DB);

// ==============================
// å…¨å±€çŠ¶æ€ï¼ˆç›´æ¥åŠ è½½ï¼Œæ— ç™»å½•ï¼‰
// ==============================
let state = {
  profile: { gender: 'female', age: 25, height: 165, weight: 55, activity: 1.375, mode: 'lose' },
  target: { bmr: 0, tdee: 0, cal: 0, pro: 0, fat: 0, car: 0 },
  mealSplit: { breakfast: 0, lunch: 0, dinner: 0, snack: 0 },
  foodData: { breakfast: [], lunch: [], dinner: [], snack: [] },
  total: { cal: 0, pro: 0, fat: 0, car: 0 },
  favList: JSON.parse(localStorage.getItem('favList') || '[]'),
  weightList: JSON.parse(localStorage.getItem('weightList') || '[]'),
  currentFood: { name: '', gram: 100, cal: 0, pro: 0, fat: 0, car: 0 }
};

// é¡µé¢åŠ è½½æ—¶ç›´æ¥åŠ è½½æœ¬åœ°æ•°æ®
window.onload = function() {
  loadState();
};

// ==============================
// åˆ†äº«åŠŸèƒ½
// ==============================
function shareApp() {
  const url = window.location.href;
  if (navigator.share) {
    navigator.share({
      title: 'è¥å…»å°ç®¡å®¶ - é¥®é£Ÿè®°å½• & ä½“é‡ç®¡ç†',
      text: 'è¶…å¥½ç”¨çš„é¥®é£Ÿè¥å…»è®¡ç®—å™¨ï¼Œå¿«æ¥è¯•è¯•å§ï¼',
      url: url
    }).catch(err => {
      copyToClipboard(url);
    });
  } else {
    copyToClipboard(url);
  }
}

function copyToClipboard(text) {
  const input = document.createElement('input');
  input.value = text;
  document.body.appendChild(input);
  input.select();
  document.execCommand('copy');
  document.body.removeChild(input);
  alert('é“¾æ¥å·²å¤åˆ¶ï¼Œå¯ç›´æ¥åˆ†äº«ç»™å¥½å‹ï¼');
}

// ==============================
// é€‰é¡¹å¡åˆ‡æ¢
// ==============================
function switchTab(tab) {
  document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('show'));
  document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
  document.getElementById(tab).classList.add('show');
  document.querySelector(`.tab:nth-child(${tab === 'diet' ? 1 : tab === 'weight' ? 2 : tab === 'report' ? 3 : 4})`).classList.add('active');
  if (tab === 'weight') drawWeightChart();
}

// ==============================
// æœç´¢è”æƒ³
// ==============================
function onSearchInput() {
  const key = document.getElementById('searchFood').value.trim();
  const suggestEl = document.getElementById('suggest');
  if (!key) {
    suggestEl.style.display = 'none';
    return;
  }
  const list = FOOD_NAMES.filter(name => name.includes(key)).slice(0, 8);
  suggestEl.innerHTML = list.map(name => `<div class="suggest-item" onclick="selectFood('${name}')">${name}</div>`).join('');
  suggestEl.style.display = 'block';
}

function selectFood(name) {
  document.getElementById('searchFood').value = name;
  document.getElementById('suggest').style.display = 'none';
  state.currentFood.name = name;
}

// ==============================
// å¡«å……è¥å…»
// ==============================
function fillFood() {
  const name = document.getElementById('searchFood').value.trim();
  const gram = parseInt(document.getElementById('foodGram').value) || 100;
  if (!name || !FOOD_DB[name]) {
    alert('æœªæ‰¾åˆ°è¯¥é£Ÿç‰©');
    return;
  }
  const base = FOOD_DB[name];
  const cal = Math.round(base.cal * gram / 100);
  const pro = (base.pro * gram / 100).toFixed(1);
  const fat = (base.fat * gram / 100).toFixed(1);
  const car = (base.car * gram / 100).toFixed(1);
  state.currentFood = { name, gram, cal, pro, fat, car };
  document.getElementById('foodCal').textContent = cal;
  document.getElementById('foodPro').textContent = pro;
  document.getElementById('foodFat').textContent = fat;
  document.getElementById('foodCar').textContent = car;
}

// ==============================
// æ”¶è—
// ==============================
function toggleFav() {
  const el = document.getElementById('favList');
  el.style.display = el.style.display === 'none' ? 'block' : 'none';
  renderFav();
}

function renderFav() {
  const el = document.getElementById('favList');
  el.innerHTML = state.favList.map(name => `
    <div class="fav-item">
      <span onclick="selectFood('${name}');fillFood()">${name}</span>
      <span class="del" onclick="delFav('${name}')">Ã—</span>
    </div>
  `).join('');
}

function addFav() {
  const name = state.currentFood.name;
  if (!name || !FOOD_DB[name]) {
    alert('è¯·å…ˆé€‰æ‹©æœ‰æ•ˆé£Ÿç‰©');
    return;
  }
  if (state.favList.includes(name)) {
    alert('å·²æ”¶è—');
    return;
  }
  state.favList.push(name);
  localStorage.setItem('favList', JSON.stringify(state.favList));
  renderFav();
  alert('æ”¶è—æˆåŠŸ');
}

function delFav(name) {
  state.favList = state.favList.filter(n => n !== name);
  localStorage.setItem('favList', JSON.stringify(state.favList));
  renderFav();
}

// ==============================
// è®¡ç®—ç›®æ ‡
// ==============================
function calcTarget() {
  const gender = document.getElementById('gender').value;
  const age = parseInt(document.getElementById('age').value) || 25;
  const height = parseInt(document.getElementById('height').value) || 165;
  const weight = parseInt(document.getElementById('weight').value) || 55;
  const activity = parseFloat(document.getElementById('activity').value);
  const mode = document.getElementById('mode').value;

  state.profile = { gender, age, height, weight, activity, mode };

  let bmr;
  if (gender === 'male') {
    bmr = 10 * weight + 6.25 * height - 5 * age + 5;
  } else {
    bmr = 10 * weight + 6.25 * height - 5 * age - 161;
  }
  const tdee = bmr * activity;

  let factor = 1;
  if (mode === 'lose') factor = 0.85;
  if (mode === 'gain') factor = 1.1;
  if (mode === 'pregnant') factor = 1.15;

  const targetCal = tdee * factor;

  let pro, fat;
  if (mode === 'pregnant') {
    pro = Math.round(1.2 * weight);
    fat = Math.round(0.9 * weight);
  } else {
    pro = Math.round(2.0 * weight);
    fat = Math.round(0.8 * weight);
  }
  const car = Math.round((targetCal - pro * 4 - fat * 9) / 4);

  state.target = { bmr: Math.round(bmr), tdee: Math.round(tdee), cal: Math.round(targetCal), pro, fat, car };

  state.mealSplit = {
    breakfast: Math.round(targetCal * 0.3),
    lunch: Math.round(targetCal * 0.4),
    dinner: Math.round(targetCal * 0.2),
    snack: Math.round(targetCal * 0.1)
  };

  renderTarget();
  renderMealSplit();
  calcTotal();
  saveState();
}

function renderTarget() {
  document.getElementById('bmr').textContent = state.target.bmr;
  document.getElementById('tdee').textContent = state.target.tdee;
  document.getElementById('targetCal').textContent = state.target.cal;
  document.getElementById('targetPro').textContent = state.target.pro;
  document.getElementById('targetFat').textContent = state.target.fat;
  document.getElementById('targetCar').textContent = state.target.car;
  document.getElementById('targetCard').style.display = 'block';
  document.getElementById('totalCard').style.display = 'block';
}

function renderMealSplit() {
  document.getElementById('breakfastTarget').textContent = state.mealSplit.breakfast;
  document.getElementById('lunchTarget').textContent = state.mealSplit.lunch;
  document.getElementById('dinnerTarget').textContent = state.mealSplit.dinner;
  document.getElementById('snackTarget').textContent = state.mealSplit.snack;
  document.getElementById('mealSplitCard').style.display = 'block';
}

// ==============================
// æ·»åŠ é¤é£Ÿ
// ==============================
function addMeal(type) {
  const food = state.currentFood;
  if (!food.name || food.cal <= 0) {
    alert('è¯·å…ˆå¡«å……é£Ÿç‰©');
    return;
  }
  state.foodData[type].push({ ...food });
  renderMeal(type);
  calcTotal();
  saveState();
}

function renderMeal(type) {
  const el = document.getElementById(`${type}List`);
  el.innerHTML = state.foodData[type].map((item, i) => `
    <div class="item">
      <span>${item.name} ${item.gram}g</span>
      <span>${item.cal}kcal</span>
      <button class="btn-mini danger" onclick="delMeal('${type}',${i})">åˆ </button>
    </div>
  `).join('');
}

function delMeal(type, idx) {
  state.foodData[type].splice(idx, 1);
  renderMeal(type);
  calcTotal();
  saveState();
}

// ==============================
// è®¡ç®—æ€»è®¡ & æ¯é¤å¯¹æ¯”
// ==============================
function calcTotal() {
  let total = { cal: 0, pro: 0, fat: 0, car: 0 };
  let mealTotal = { breakfast: 0, lunch: 0, dinner: 0, snack: 0 };

  ['breakfast', 'lunch', 'dinner', 'snack'].forEach(t => {
    state.foodData[t].forEach(item => {
      total.cal += parseInt(item.cal);
      total.pro += parseFloat(item.pro);
      total.fat += parseFloat(item.fat);
      total.car += parseFloat(item.car);
      mealTotal[t] += parseInt(item.cal);
    });
  });

  state.total = total;

  document.getElementById('totalCal').textContent = total.cal;
  document.getElementById('totalPro').textContent = total.pro.toFixed(1);
  document.getElementById('totalFat').textContent = total.fat.toFixed(1);
  document.getElementById('totalCar').textContent = total.car.toFixed(1);
  document.getElementById('totalCalTarget').textContent = state.target.cal;
  document.getElementById('totalProTarget').textContent = state.target.pro;
  document.getElementById('totalFatTarget').textContent = state.target.fat;
  document.getElementById('totalCarTarget').textContent = state.target.car;

  const calPer = Math.min((total.cal / state.target.cal) * 100, 100) || 0;
  const proPer = Math.min((total.pro / state.target.pro) * 100, 100) || 0;
  const fatPer = Math.min((total.fat / state.target.fat) * 100, 100) || 0;
  const carPer = Math.min((total.car / state.target.car) * 100, 100) || 0;

  document.getElementById('totalCalPer').style.width = calPer + '%';
  document.getElementById('totalProPer').style.width = proPer + '%';
  document.getElementById('totalFatPer').style.width = fatPer + '%';
  document.getElementById('totalCarPer').style.width = carPer + '%';

  document.getElementById('breakfastTotal').textContent = mealTotal.breakfast;
  document.getElementById('lunchTotal').textContent = mealTotal.lunch;
  document.getElementById('dinnerTotal').textContent = mealTotal.dinner;
  document.getElementById('snackTotal').textContent = mealTotal.snack;

  document.getElementById('breakfastPer').style.width = Math.min((mealTotal.breakfast / state.mealSplit.breakfast) * 100, 100) + '%';
  document.getElementById('lunchPer').style.width = Math.min((mealTotal.lunch / state.mealSplit.lunch) * 100, 100) + '%';
  document.getElementById('dinnerPer').style.width = Math.min((mealTotal.dinner / state.mealSplit.dinner) * 100, 100) + '%';
  document.getElementById('snackPer').style.width = Math.min((mealTotal.snack / state.mealSplit.snack) * 100, 100) + '%';
}

// ==============================
// æ¸…ç©ºä»Šæ—¥
// ==============================
function clearAll() {
  if (!confirm('ç¡®å®šæ¸…ç©ºä»Šæ—¥æ‰€æœ‰è®°å½•ï¼Ÿ')) return;
  state.foodData = { breakfast: [], lunch: [], dinner: [], snack: [] };
  ['breakfast', 'lunch', 'dinner', 'snack'].forEach(renderMeal);
  calcTotal();
  saveState();
}

// ==============================
// æœ¬åœ°å­˜å‚¨
// ==============================
function saveState() {
  localStorage.setItem('foodState', JSON.stringify(state));
}

function loadState() {
  const s = localStorage.getItem('foodState');
  if (s) state = JSON.parse(s);
  renderTarget();
  renderMealSplit();
  ['breakfast', 'lunch', 'dinner', 'snack'].forEach(renderMeal);
  calcTotal();
  renderFav();
}

// ==============================
// ä½“é‡è®°å½•
// ==============================
function saveWeight() {
  const w = parseFloat(document.getElementById('todayWeight').value);
  if (!w || w < 20 || w > 300) {
    alert('è¯·è¾“å…¥æœ‰æ•ˆä½“é‡');
    return;
  }
  const now = new Date();
  const date = now.toISOString().split('T')[0];
  const list = state.weightList;
  const idx = list.findIndex(item => item.date === date);
  if (idx >= 0) list[idx].weight = w;
  else list.push({ date, weight: w });
  list.sort((a, b) => a.date.localeCompare(b.date));
  if (list.length > 30) list.splice(0, list.length - 30);
  state.weightList = list;
  localStorage.setItem('weightList', JSON.stringify(list));
  document.getElementById('todayWeight').value = '';
  renderWeightHistory();
  drawWeightChart();
}

function renderWeightHistory() {
  const el = document.getElementById('weightHistory');
  el.innerHTML = state.weightList.map(item => `
    <div class="history-item">
      <span>${item.date}</span>
      <span>${item.weight} kg</span>
    </div>
  `).join('');
}

function drawWeightChart() {
  const list = state.weightList;
  if (list.length < 2) return;
  const ctx = document.getElementById('weightChart').getContext('2d');
  const canvas = ctx.canvas;
  const w = canvas.width;
  const h = canvas.height;
  ctx.clearRect(0, 0, w, h);

  const weights = list.map(i => i.weight);
  const minW = Math.min(...weights);
  const maxW = Math.max(...weights);
  const range = maxW - minW || 1;
  const pad = 30;

  ctx.strokeStyle = '#ff7b9c';
  ctx.lineWidth = 2.5;
  ctx.beginPath();
  list.forEach((item, i) => {
    const x = pad + (w - 2 * pad) * (i / (list.length - 1));
    const y = h - pad - ((item.weight - minW) / range) * (h - 2 * pad);
    if (i === 0) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
    ctx.arc(x, y, 3.5, 0, Math.PI * 2);
  });
  ctx.stroke();
}

// ==============================
// è¥å…»åˆ†ææŠ¥å‘Š
// ==============================
function genReport() {
  const t = state.target;
  const total = state.total;
  if (t.cal === 0) {
    document.getElementById('reportContent').textContent = 'è¯·å…ˆè®¡ç®—æ¨èç›®æ ‡';
    return;
  }
  const calPct = Math.round((total.cal / t.cal) * 100);
  const proPct = Math.round((total.pro / t.pro) * 100);
  const fatPct = Math.round((total.fat / t.fat) * 100);
  const carPct = Math.round((total.car / t.car) * 100);

  let advice = '';
  if (calPct < 80) advice = 'ä»Šæ—¥çƒ­é‡æ‘„å…¥åä½ï¼Œå¯é€‚å½“å¢åŠ ä¸»é£Ÿæˆ–ä¼˜è´¨è›‹ç™½ï¼Œé¿å…ä»£è°¢ä¸‹é™ã€‚';
  else if (calPct > 120) advice = 'ä»Šæ—¥çƒ­é‡æ‘„å…¥åé«˜ï¼Œå»ºè®®å‡å°‘ç²¾åˆ¶ç¢³æ°´ä¸æ²¹è„‚ï¼Œå¢åŠ è”¬èœæ¯”ä¾‹ã€‚';
  else advice = 'ä»Šæ—¥çƒ­é‡æ‘„å…¥åˆç†ï¼Œç»§ç»­ä¿æŒã€‚';

  if (proPct < 70) advice += '\nè›‹ç™½è´¨æ‘„å…¥ä¸è¶³ï¼Œå»ºè®®å¢åŠ é¸¡èƒ¸è‚‰ã€é±¼è™¾ã€é¸¡è›‹ã€è±†åˆ¶å“ã€‚';
  if (fatPct < 70) advice += '\nè„‚è‚ªæ‘„å…¥åä½ï¼Œå¯é€‚é‡å¢åŠ åšæœã€æ©„æ¦„æ²¹ã€æ·±æµ·é±¼ã€‚';
  if (carPct < 70) advice += '\nç¢³æ°´æ‘„å…¥åä½ï¼Œå¯å¢åŠ å…¨è°·ç‰©ã€è–¯ç±»ï¼Œä¿è¯ä¾›èƒ½ã€‚';

  const report = `
ã€ä»Šæ—¥è¥å…»åˆ†ææŠ¥å‘Šã€‘
ç›®æ ‡çƒ­é‡ï¼š${t.cal} kcalï¼Œå®é™…æ‘„å…¥ï¼š${total.cal} kcalï¼ˆ${calPct}%ï¼‰
ç›®æ ‡è›‹ç™½è´¨ï¼š${t.pro} gï¼Œå®é™…ï¼š${total.pro.toFixed(1)} gï¼ˆ${proPct}%ï¼‰
ç›®æ ‡è„‚è‚ªï¼š${t.fat} gï¼Œå®é™…ï¼š${total.fat.toFixed(1)} gï¼ˆ${fatPct}%ï¼‰
ç›®æ ‡ç¢³æ°´ï¼š${t.car} gï¼Œå®é™…ï¼š${total.car.toFixed(1)} gï¼ˆ${carPct}%ï¼‰

ã€é¥®é£Ÿå»ºè®®ã€‘
${advice}

ã€ä¸­å›½å±…æ°‘è†³é£ŸæŒ‡å— 2022 è¦ç‚¹ã€‘
â€¢ è°·è–¯ç±»å æ¯æ—¥ä¸»é£Ÿ 50% ä»¥ä¸Š
â€¢ æ¯æ—¥è”¬èœ â‰¥ 500gï¼Œæ·±è‰²è”¬èœå ä¸€åŠ
â€¢ æ¯æ—¥å¥¶ç±» 300-500g
â€¢ æ¯å‘¨åƒé±¼ â‰¥ 2 æ¬¡
â€¢ æ§æ²¹ 25-30gï¼Œé™ç³– â‰¤ 25g
  `;
  document.getElementById('reportContent').textContent = report;
}

// ==============================
// é£Ÿè°±æ¨è
// ==============================
function genRecipe() {
  const mode = state.profile.mode;
  let recipes = [];
  if (mode === 'lose') {
    recipes = [
      {
        name: 'å‡è„‚æ—©é¤ï¼šå…¨éº¦åå¸+é¸¡è›‹+æ— ç³–é…¸å¥¶',
        desc: 'å…¨éº¦åå¸1ç‰‡+æ°´ç…®è›‹1ä¸ª+æ— ç³–é…¸å¥¶150g+å°ç•ªèŒ„5é¢—ï¼Œçƒ­é‡çº¦350kcalï¼Œé«˜è›‹ç™½é«˜çº¤ç»´ã€‚'
      },
      {
        name: 'å‡è„‚åˆé¤ï¼šæ‚ç²®é¥­+é¸¡èƒ¸è‚‰+è¥¿å…°èŠ±',
        desc: 'æ‚ç²®é¥­100g+é¦™ç…é¸¡èƒ¸è‚‰120g+æ¸…ç‚’è¥¿å…°èŠ±200gï¼Œçƒ­é‡çº¦500kcalï¼Œè›‹ç™½å……è¶³ã€‚'
      },
      {
        name: 'å‡è„‚æ™šé¤ï¼šè±†è…è”¬èœæ±¤+çº¢è–¯',
        desc: 'å«©è±†è…150g+è èœ150g+èŒè‡ç…®æ±¤+å°çº¢è–¯150gï¼Œçƒ­é‡çº¦300kcalï¼Œæ¸…æ·¡é¥±è…¹ã€‚'
      }
    ];
  } else if (mode === 'gain') {
    recipes = [
      {
        name: 'å¢è‚Œæ—©é¤ï¼šç‡•éº¦+ç‰›å¥¶+é¸¡è›‹+åšæœ',
        desc: 'ç‡•éº¦50g+ç‰›å¥¶300ml+å…¨è›‹2ä¸ª+æä»10gï¼Œçƒ­é‡çº¦550kcalï¼Œé«˜è›‹ç™½é«˜ç¢³æ°´ã€‚'
      },
      {
        name: 'å¢è‚Œåˆé¤ï¼šç³™ç±³é¥­+ç˜¦ç‰›è‚‰+å½©æ¤’',
        desc: 'ç³™ç±³é¥­150g+ç˜¦ç‰›è‚‰150g+å½©æ¤’200gï¼Œçƒ­é‡çº¦650kcalï¼Œå¢è‚Œå‹å¥½ã€‚'
      },
      {
        name: 'å¢è‚Œæ™šé¤ï¼šä¸‰æ–‡é±¼+åœŸè±†+èŠ¦ç¬‹',
        desc: 'ä¸‰æ–‡é±¼150g+çƒ¤åœŸè±†200g+èŠ¦ç¬‹150gï¼Œçƒ­é‡çº¦600kcalï¼Œä¼˜è´¨è„‚è‚ªå……è¶³ã€‚'
      }
    ];
  } else if (mode === 'pregnant') {
    recipes = [
      {
        name: 'å­•å¦‡æ—©é¤ï¼šå°ç±³ç²¥+é¸¡è›‹+ç‰›å¥¶+è‹¹æœ',
        desc: 'å°ç±³ç²¥1ç¢—+æ°´ç…®è›‹1ä¸ª+ç‰›å¥¶250ml+è‹¹æœ1ä¸ªï¼Œæ¸©å’Œæ˜“æ¶ˆåŒ–ï¼Œè¡¥é“è¡¥é’™ã€‚'
      },
      {
        name: 'å­•å¦‡åˆé¤ï¼šæ‚ç²®é¥­+æ¸…è’¸é±¼+è èœ',
        desc: 'æ‚ç²®é¥­100g+æ¸…è’¸é²ˆé±¼150g+æ¸…ç‚’è èœ200gï¼Œä¼˜è´¨è›‹ç™½+å¶é…¸ä¸°å¯Œã€‚'
      },
      {
        name: 'å­•å¦‡æ™šé¤ï¼šè™¾ä»è±†è…+è¥¿å…°èŠ±+çº¢è–¯',
        desc: 'è™¾ä»100g+å«©è±†è…150g+è¥¿å…°èŠ±150g+å°çº¢è–¯150gï¼Œæ¸…æ·¡è¥å…»ï¼Œè¡¥é’™è¡¥é“ã€‚'
      }
    ];
  } else {
    recipes = [
      {
        name: 'ç»´æŒæ—©é¤ï¼šç‡•éº¦ç²¥+é¸¡è›‹+å°ç•ªèŒ„',
        desc: 'ç‡•éº¦ç²¥1ç¢—+æ°´ç…®è›‹1ä¸ª+å°ç•ªèŒ„5é¢—ï¼Œçƒ­é‡çº¦400kcalï¼Œå‡è¡¡è¥å…»ã€‚'
      },
      {
        name: 'ç»´æŒåˆé¤ï¼šç³™ç±³é¥­+ç˜¦ç‰›è‚‰+è¥¿å…°èŠ±',
        desc: 'ç³™ç±³é¥­120g+ç˜¦ç‰›è‚‰120g+è¥¿å…°èŠ±200gï¼Œçƒ­é‡çº¦550kcalï¼Œå‡è¡¡ä¾›èƒ½ã€‚'
      },
      {
        name: 'ç»´æŒæ™šé¤ï¼šé¸¡èƒ¸è‚‰è”¬èœæ²™æ‹‰+çº¢è–¯',
        desc: 'é¸¡èƒ¸è‚‰100g+æ··åˆè”¬èœ200g+å°çº¢è–¯150gï¼Œçƒ­é‡çº¦400kcalï¼Œæ¸…æ·¡å‡è¡¡ã€‚'
      }
    ];
  }
  document.getElementById('recipeList').innerHTML = recipes.map(r => `
    <div class="recipe-item">
      <h3>${r.name}</h3>
      <p>${r.desc}</p>
    </div>
  `).join('');
}
</script>

</body>
</html>
